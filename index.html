<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Avfile - Free file sharing service with 100MB limit per file. Share files instantly, anonymously, and completely free. No registration required, unlimited transfers, optional password protection. Lightning fast uploads and downloads. Get shareable links in seconds.">
    <meta name="keywords" content="free file sharing,fast file sharing,anonymous file sharing,100mb file upload,secure file sharing,no registration file sharing,unlimited free file sharing,video sharing,image sharing,document sharing,file transfer,password protected sharing,instant file sharing,cloud storage,online file sharing,temporary file sharing,large file sharing,multiple file sharing">
    <meta name="author" content="Avfile">
    <meta name="theme-color" content="#0f0f1e">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <!-- ★ キャッシュ制御タグ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ★ SEO追加メタタグ -->
    <link rel="canonical" href="https://avfile.io">
    <meta property="article:modified_time" content="2024-01-23T00:00:00+00:00">
    
    <!-- OGP (Open Graph Protocol) -->
    <meta property="og:title" content="Avfile - Free File Sharing Service - Share 100MB Files Instantly & Anonymously">
    <meta property="og:description" content="Share files instantly, anonymously, and completely free. Upload up to 100MB files with optional password protection. No registration, unlimited transfers. Fast, secure, 100% free forever.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://avfile.io">
    <meta property="og:image" content="https://avfile.io/images/folder.png">
    <meta property="og:site_name" content="Avfile">
    <meta property="og:locale" content="en_US">

    
    <!-- ★ JSON-LD スキーマ -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Avfile",
      "description": "Free anonymous file sharing service. Upload up to 100MB per file with unlimited transfers. No registration required, optional password protection, completely free forever.",
      "url": "https://avfile.io",
      "applicationCategory": "UtilityApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "1250"
      },
      "features": [
        "Anonymous file sharing - no registration required",
        "Completely free - unlimited transfers forever",
        "100MB maximum file size per upload",
        "Optional password protection for security",
        "Lightning fast upload and download speeds",
        "Multiple file sharing capability",
        "No expiration dates on shared files",
        "Instant shareable links generation"
      ]
    }
    </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/folder.png">
    <link rel="shortcut icon" href="/images/folder.png">
    <link rel="apple-touch-icon" href="/images/folder.png">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <title>Avfile - Free Anonymous File Sharing - 100MB Limit - Share Files Instantly & Securely</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%); 
            color: #ffffff; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar { 
            background: rgba(15, 15, 30, 0.95); 
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        .logo-container { 
            display: flex; 
            align-items: center; 
            gap: 1rem;
        }

        .logo-text { 
            font-size: 1.3rem; 
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
        }
        
        .policy-btn {
            color: #ffffff;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .policy-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .container { 
            flex: 1;
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 1rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #ffffff;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
            font-weight: 300;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 4rem 3rem;
            margin: 2rem 0;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.03);
        }

        .upload-area.drag-over {
            border-color: #ffffff;
            background: rgba(255, 255, 255, 0.08);
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .upload-icon::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 14px solid rgba(255, 255, 255, 0.8);
        }
        
        .upload-icon::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 16px;
            background: rgba(255, 255, 255, 0.8);
            bottom: 8px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .upload-area h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #ffffff;
            font-weight: 600;
        }

        .upload-area p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 1.5rem;
        }

        input[type="file"] { display: none; }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 0.9rem 2.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 1.5rem;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        /* ★ パスワード保護セクション */
        .password-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .password-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .password-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 34px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 17px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 26px;
            height: 26px;
            background: #ffffff;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 30px;
        }

        .password-input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .password-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .password-input-wrapper input {
            flex: 1;
        }

        .password-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            color: #ffffff;
            font-size: 1rem;
        }

        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .password-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .toggle-password-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .toggle-password-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .password-strength {
            display: flex;
            gap: 0.3rem;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .strength-bar {
            width: 20px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .strength-bar.weak { background: #ff6b6b; }
        .strength-bar.medium { background: #ffd93d; }
        .strength-bar.strong { background: #4caf50; }

        .strength-text {
            color: rgba(255, 255, 255, 0.6);
        }

        .password-info {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }

        .password-info li {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .features-section {
            margin-top: 6rem;
            padding: 3rem 2rem;
        }

        .features-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: #ffffff;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 1rem;
            border-left: 4px solid rgba(255, 255, 255, 0.6);
            padding-left: 12px;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.8rem;
        }

        .feature-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }

        .upload-status-screen, .success-screen, .error-screen, .file-viewer-container, .loading-screen {
            display: none;
        }

        .upload-status-screen.show, .success-screen.show, .error-screen.show, 
        .file-viewer-container.show, .loading-screen.show {
            display: block;
        }

        .upload-status-screen, .error-screen {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 4rem 2rem;
            margin: 3rem 0;
            text-align: center;
        }

        .success-screen {
            background: rgba(76, 175, 80, 0.08);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 16px;
            padding: 4rem 2rem;
            margin: 3rem 0;
            text-align: center;
        }

        .error-screen {
            background: rgba(255, 107, 107, 0.08);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .status-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .success-screen .status-title { color: #4caf50; }
        .error-screen .status-title { color: #ff6b6b; }

        .success-icon { font-size: 4rem; margin-bottom: 1.5rem; }
        .error-icon { font-size: 4rem; margin-bottom: 1.5rem; }

        .share-url-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .share-url-input-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .share-url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            color: #ffffff;
            font-size: 0.9rem;
            word-break: break-all;
            min-width: 200px;
        }

        .copy-btn {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #ffffff;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .copy-btn:hover { 
            background: rgba(76, 175, 80, 0.5);
            transform: translateY(-2px); 
        }

        .action-button {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 0.5rem;
            transition: all 0.3s;
        }

        .action-button:hover { 
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .progress-bar {
            width: 100%;
            max-width: 500px;
            height: 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 7px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 0 auto 0.8rem;
        }

        .progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            width: 0%;
            transition: width 0.4s ease;
        }

        .carousel-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .carousel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .carousel-title {
            font-size: 1.3rem;
            color: #ffffff;
            font-weight: bold;
        }

        .carousel-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
        }

        .carousel-viewport { width: 100%; overflow: hidden; }
        .carousel-track { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .carousel-item { flex: 0 0 100%; padding: 2rem; min-height: 400px; display: flex; flex-direction: column; }

        .carousel-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .carousel-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .carousel-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .carousel-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dot.active { background: #ffffff; width: 32px; border-radius: 6px; }

        .file-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .file-item-info { display: flex; gap: 1rem; align-items: flex-start; }
        .file-icon { font-size: 3rem; }
        .file-details h3 { font-size: 1.2rem; color: #ffffff; margin-bottom: 0.3rem; word-break: break-word; }
        .file-details p { font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); }

        .file-item-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .file-action-btn { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .file-action-btn:hover { background: rgba(255, 255, 255, 0.15); }

        .file-preview-area {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 2rem;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1.5rem;
        }

        .file-preview-area video {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .file-preview-area img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            object-fit: contain;
        }

        .file-preview-area audio {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .file-preview-area a {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-block;
        }

        .file-preview-area a:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .folder-icon {
            width: 200px;
            height: 200px;
            background: url('/images/folder.png') center/contain no-repeat;
            margin: 0 auto;
        }

        .password-status-box {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            color: #4caf50;
        }

        .footer {
            margin-top: 4rem;
            padding: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .hero-title { font-size: 2.2rem; }
            .hero-subtitle { font-size: 1rem; }
            .upload-section { padding: 2rem 1.5rem; }
            .upload-area { padding: 2rem 1rem; min-height: 250px; }
            .upload-icon { font-size: 2.5rem; }
            .password-section { padding: 1.5rem; }
            .password-input-wrapper { flex-direction: column; }
            .file-item-header { flex-direction: column; }
            .file-item-actions { width: 100%; }
            .file-item-actions button, .file-item-actions a { flex: 1; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo-container">
                <div class="logo-text">Avfile</div>
            </div>
            <a href="policy.html" class="policy-btn">Policy</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" id="mainContainer">
        <!-- Upload UI (Home) -->
        <div id="uploadUI">
            <div class="hero">
                <h1 class="hero-title">Free Anonymous File Sharing</h1>
                <p class="hero-subtitle">
                    Share files instantly, completely free, and 100% anonymous. Upload up to 100MB per file with unlimited transfers. 
                    Optional password protection, no registration required, lightning fast speeds. Get your shareable link in seconds.
                </p>
            </div>

            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"></div>
                    <h2>Select Files to Upload</h2>
                    <p>Click the button below to choose files from your device</p>
                    <input type="file" id="fileInput" multiple accept="*/*" />
                    <button class="btn" id="selectFileBtn">Select Files to Upload</button>
                    <p class="upload-hint">Up to 10 files • 100MB limit per file • Unlimited transfers • Completely free • Optional password protection</p>
                </div>

                <!-- ★ パスワード保護セクション -->
                <div class="password-section">
                    <div class="password-section-title">
                        Password Protection (Optional)
                    </div>
                    
                    <div class="password-toggle">
                        <div class="toggle-switch" id="passwordToggle">
                            <div class="toggle-slider"></div>
                        </div>
                        <label for="passwordInput" style="cursor: pointer; color: rgba(255, 255, 255, 0.8);">
                            Protect your files with a password
                        </label>
                    </div>

                    <div class="password-input-group" id="passwordInputGroup" style="display: none;">
                        <div class="password-input-wrapper">
                            <input 
                                type="password" 
                                id="passwordInput" 
                                class="password-input" 
                                placeholder="Enter password (8+ characters recommended)"
                                minlength="1"
                                maxlength="256"
                            />
                            <button class="toggle-password-btn" id="togglePasswordBtn">Show</button>
                        </div>

                        <div class="password-strength" id="passwordStrength" style="display: none;">
                            <span class="strength-bar"></span>
                            <span class="strength-bar"></span>
                            <span class="strength-bar"></span>
                            <span class="strength-text" id="strengthText">Weak</span>
                        </div>

                        <div class="password-info">
                            <strong>Password Tips:</strong>
                            <ul>
                                <li>Minimum 6 characters recommended</li>
                                <li>Recipients will need this password to access files</li>
                                <li>Password is hashed and stored securely</li>
                                <li>Use strong passwords for sensitive content</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <div class="features-section">
                <h2 class="features-title">Why Choose Avfile?</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-title">100% Free Forever</div>
                        <div class="feature-description">
                            Completely free file sharing. No hidden fees, no premium plans, no credit card required. Unlimited transfers forever.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-title">100MB Per File</div>
                        <div class="feature-description">
                            Upload files up to 100MB each. Perfect for documents, videos, images, and more. Share up to 10 files at once.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-title">Completely Anonymous</div>
                        <div class="feature-description">
                            No registration, no login, no tracking. Share files anonymously without giving away personal information.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-title">Lightning Fast</div>
                        <div class="feature-description">
                            Upload and download at blazing speeds. Get your shareable link within seconds, not minutes.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-title">Password Protection</div>
                        <div class="feature-description">
                            Optional password protection with SHA-256 encryption. Secure your files with just one click.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-title">Files Never Expire</div>
                        <div class="feature-description">
                            Your files stay online forever. Share links anytime, anywhere. Recipients can access files indefinitely.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Status Screen -->
        <div class="upload-status-screen" id="uploadStatusScreen">
            <div class="spinner"></div>
            <div class="status-title">Uploading Files...</div>
            <div id="statusMessage">0 / 0 files</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressPercent">0%</div>
        </div>

        <!-- Success Screen -->
        <div class="success-screen" id="successScreen">
            <div class="success-icon">✓</div>
            <div class="status-title">Upload Complete!</div>
            <div style="color: rgba(255, 255, 255, 0.8); margin-bottom: 2rem;">Your files are ready to share</div>
            
            <!-- ★ パスワード保護状態を表示 -->
            <div id="passwordStatusBox" class="password-status-box" style="display: none;">
                This link is password protected
            </div>

            <div class="share-url-box">
                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.8rem;">Share this link:</div>
                <div class="share-url-input-group">
                    <input type="text" id="shareUrl" readonly class="share-url-input" />
                    <button class="copy-btn" id="copyUrlBtn">Copy Link</button>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <button class="action-button" id="uploadMoreBtn">Upload More Files</button>
                <button class="action-button" id="openLinkBtn">Open Shared Link</button>
            </div>
        </div>

        <!-- Error Screen -->
        <div class="error-screen" id="errorScreen">
            <div class="error-icon">✗</div>
            <div class="status-title">Upload Failed</div>
            <div id="errorMsg" style="color: rgba(255, 255, 255, 0.8);">An error occurred</div>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <button class="action-button" style="background: rgba(255, 107, 107, 0.2); border-color: rgba(255, 107, 107, 0.4);" id="retryBtn">Try Again</button>
                <button class="action-button" id="backBtn">Back to Home</button>
            </div>
        </div>

        <!-- File Viewer -->
        <div class="file-viewer-container" id="fileViewerContainer">
            <div class="carousel-container">
                <div class="carousel-header">
                    <div class="carousel-title">Your Shared Files</div>
                    <!-- ★ ホームボタンを追加 -->
                    <button class="action-button" id="homeBtn" style="background: rgba(100, 150, 255, 0.2); border-color: rgba(100, 150, 255, 0.4); padding: 0.5rem 1rem; font-size: 0.9rem;">Home</button>
                </div>

                <div class="carousel-wrapper">
                    <div class="carousel-viewport">
                        <div class="carousel-track" id="carouselTrack"></div>
                    </div>
                </div>

                <div class="carousel-controls">
                    <button class="carousel-btn" id="prevBtn">Previous</button>
                    <span id="slideInfo" style="color: #ffffff;">1 / 1</span>
                    <button class="carousel-btn" id="nextBtn">Next</button>
                </div>

                <div class="carousel-dots" id="carouselDots"></div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingUI">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; color: rgba(255, 255, 255, 0.7);">Loading your files...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2026 Avfile • Free Anonymous File Sharing • 100MB Limit • Unlimited Transfers • 100% Free Forever</p>
    </footer>

    <script src="/js/chunked-binary-uploader.js"></script>
    <script src="/js/universal-file-uploader-enhanced.js"></script>
    <script src="/js/password-viewer.js"></script>

    <script>
        // ★ グローバル変数定義
        const MAX_FILES = 10;
        const MAX_FILE_SIZE = 500 * 1024 * 1024;
        const VIDEO_COMPRESSION_THRESHOLD = 200 * 1024 * 1024;
        const CHUNK_SIZE = 5 * 1024 * 1024;

        // ★ パスワード保護の状態を管理
        let passwordProtectionEnabled = false;
        let currentPassword = '';

        /**
         * パスワード強度を計算
         */
        function calculatePasswordStrength(password) {
            let strength = 0;
            if (!password) return 0;
            
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;
            
            return Math.min(strength, 3);
        }

        /**
         * パスワード強度表示を更新
         */
        function updatePasswordStrength(password) {
            const strength = calculatePasswordStrength(password);
            const strengthBox = document.getElementById('passwordStrength');
            const bars = strengthBox.querySelectorAll('.strength-bar');
            const text = document.getElementById('strengthText');

            bars.forEach((bar, i) => {
                bar.className = 'strength-bar';
                if (i < strength) {
                    bar.classList.add(strength === 1 ? 'weak' : strength === 2 ? 'medium' : 'strong');
                }
            });

            const strengthTexts = ['Weak', 'Weak', 'Medium', 'Strong'];
            text.textContent = strengthTexts[strength] || 'Weak';
            text.style.color = strength === 1 ? '#ff6b6b' : strength === 2 ? '#ffd93d' : '#4caf50';

            strengthBox.style.display = 'flex';
        }

        /**
         * SHA-256ハッシュ計算
         */
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        /**
         * ランダムなアルファベット7桁文字列を生成
         */
        function generateRandomFileName() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
            let result = '';
            for (let i = 0; i < 7; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        /**
         * ファイル情報を取得
         */
        async function getUnifiedFileInfo(file) {
            try {
                let ext = 'bin';
                
                // ★ ビデオファイル
                if (file.type && file.type.startsWith('video/')) {
                    if (file.type === 'video/mp4') ext = 'mp4';
                    else if (file.type === 'video/quicktime') ext = 'mov';
                    else if (file.type === 'video/webm') ext = 'webm';
                    else if (file.type === 'video/ogg') ext = 'ogg';
                    else if (file.type === 'video/x-msvideo') ext = 'avi';
                    else if (file.type === 'video/x-matroska') ext = 'mkv';
                    else if (file.type === 'video/x-flv') ext = 'flv';
                    else if (file.type === 'video/x-ms-wmv') ext = 'wmv';
                    else if (file.type === 'video/3gpp') ext = '3gp';
                    else if (file.type === 'video/3gpp2') ext = '3g2';
                    else if (file.type === 'video/mp2t') ext = 'ts';
                    else ext = 'mp4';
                }
                // ★ 画像ファイル
                else if (file.type && file.type.startsWith('image/')) {
                    if (file.type === 'image/jpeg') ext = 'jpg';
                    else if (file.type === 'image/png') ext = 'png';
                    else if (file.type === 'image/gif') ext = 'gif';
                    else if (file.type === 'image/webp') ext = 'webp';
                    else if (file.type === 'image/bmp') ext = 'bmp';
                    else if (file.type === 'image/svg+xml') ext = 'svg';
                    else if (file.type === 'image/x-icon') ext = 'ico';
                    else if (file.type === 'image/tiff') ext = 'tiff';
                    else ext = 'jpg';
                }
                // ★ 音声ファイル
                else if (file.type && file.type.startsWith('audio/')) {
                    if (file.type === 'audio/mpeg') ext = 'mp3';
                    else if (file.type === 'audio/wav') ext = 'wav';
                    else if (file.type === 'audio/ogg') ext = 'ogg';
                    else if (file.type === 'audio/flac') ext = 'flac';
                    else if (file.type === 'audio/aac') ext = 'aac';
                    else if (file.type === 'audio/mp4') ext = 'm4a';
                    else if (file.type === 'audio/webm') ext = 'webm';
                    else if (file.type === 'audio/x-ms-wma') ext = 'wma';
                    else if (file.type === 'audio/opus') ext = 'opus';
                    else ext = 'mp3';
                }
                // ★ Applicationタイプ（重要）
                else if (file.type && file.type.startsWith('application/')) {
                    if (file.type === 'application/zip') ext = 'zip';
                    else if (file.type === 'application/x-zip-compressed') ext = 'zip';
                    else if (file.type === 'application/x-rar-compressed') ext = 'rar';
                    else if (file.type === 'application/x-7z-compressed') ext = '7z';
                    else if (file.type === 'application/gzip') ext = 'gz';
                    else if (file.type === 'application/x-tar') ext = 'tar';
                    else if (file.type === 'application/x-bzip2') ext = 'bz2';
                    else if (file.type === 'application/pdf') ext = 'pdf';
                    else if (file.type === 'application/msword') ext = 'doc';
                    else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') ext = 'docx';
                    else if (file.type === 'application/vnd.ms-excel') ext = 'xls';
                    else if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') ext = 'xlsx';
                    else if (file.type === 'application/vnd.ms-powerpoint') ext = 'ppt';
                    else if (file.type === 'application/vnd.openxmlformats-officedocument.presentationml.presentation') ext = 'pptx';
                    else if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') ext = 'xlsx';
                    else if (file.type === 'application/json') ext = 'json';
                    else if (file.type === 'application/xml') ext = 'xml';
                    else if (file.type === 'application/x-www-form-urlencoded') ext = 'bin';
                    else if (file.type === 'application/octet-stream') ext = 'bin';
                    else ext = 'bin';
                }
                // ★ テキストファイル
                else if (file.type && file.type.startsWith('text/')) {
                    if (file.type === 'text/plain') ext = 'txt';
                    else if (file.type === 'text/html') ext = 'html';
                    else if (file.type === 'text/css') ext = 'css';
                    else if (file.type === 'text/javascript') ext = 'js';
                    else if (file.type === 'text/csv') ext = 'csv';
                    else if (file.type === 'text/xml') ext = 'xml';
                    else if (file.type === 'text/markdown') ext = 'md';
                    else ext = 'txt';
                }
                // ★ フォールバック - ファイル名から拡張子を抽出
                else if (file.name && file.name.includes('.')) {
                    const parts = file.name.split('.');
                    const nameExt = parts[parts.length - 1].toLowerCase();
                    // ファイル名の拡張子が有効そうか確認（1-10文字）
                    if (nameExt && nameExt.length > 0 && nameExt.length <= 10 && /^[a-z0-9]+$/.test(nameExt)) {
                        ext = nameExt;
                    }
                }

                const randomName = generateRandomFileName();
                const fileName = `${randomName}.${ext}`;

                console.log('[FILE_INFO] Original:', file.name, '→ Generated:', fileName, '(type:', file.type, ')');

                return {
                    name: fileName,
                    type: 'file',
                    size: file.size,
                    mimeType: file.type || 'application/octet-stream'
                };
            } catch (e) {
                console.error('[FILE_INFO] Error:', e.message);
                const randomName = generateRandomFileName();
                return {
                    name: `${randomName}.bin`,
                    type: 'file',
                    size: file.size,
                    mimeType: 'application/octet-stream'
                };
            }
        }

        /**
         * ファイルアイコンを取得
         */
        function getIcon(name) {
            if (!name || typeof name !== 'string') return 'F';
            const ext = name.split('.').pop().toLowerCase();
            const videoExtensions = ['mp4', 'webm', 'ogg', 'mkv', 'avi', 'mov', 'flv', 'wmv', 'm4v'];
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];
            const pdfExtensions = ['pdf'];
            
            if (videoExtensions.includes(ext)) return 'V';
            if (imageExtensions.includes(ext)) return 'I';
            if (pdfExtensions.includes(ext)) return 'P';
            return 'F';
        }

        /**
         * ファイルサイズをフォーマット
         */
        function formatSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        /**
         * HTMLをエスケープ
         */
        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        // ★ UI制御関数
        function hideAll() {
            document.getElementById('uploadUI').style.display = 'none';
            document.getElementById('uploadStatusScreen').classList.remove('show');
            document.getElementById('successScreen').classList.remove('show');
            document.getElementById('errorScreen').classList.remove('show');
            document.getElementById('fileViewerContainer').classList.remove('show');
            document.getElementById('loadingUI').classList.remove('show');
        }

        function showUpload() { hideAll(); document.getElementById('uploadUI').style.display = 'block'; }
        function showStatus() { hideAll(); document.getElementById('uploadStatusScreen').classList.add('show'); }
        function showSuccess() { hideAll(); document.getElementById('successScreen').classList.add('show'); }
        function showError(msg) { hideAll(); document.getElementById('errorMsg').textContent = msg; document.getElementById('errorScreen').classList.add('show'); }
        function showLoading() { hideAll(); document.getElementById('loadingUI').classList.add('show'); }

        // ★ パスワードトグル機能
        document.getElementById('passwordToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            document.getElementById('passwordInputGroup').style.display = 
                this.classList.contains('active') ? 'flex' : 'none';
            passwordProtectionEnabled = this.classList.contains('active');
            
            if (!passwordProtectionEnabled) {
                document.getElementById('passwordInput').value = '';
                currentPassword = '';
            }
        });

        // ★ パスワード入力時の強度表示
        document.getElementById('passwordInput').addEventListener('input', function(e) {
            const password = e.target.value;
            currentPassword = password;
            if (password) {
                updatePasswordStrength(password);
            }
        });

        // ★ パスワード表示/非表示切り替え
        document.getElementById('togglePasswordBtn').addEventListener('click', function() {
            const input = document.getElementById('passwordInput');
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            this.textContent = isPassword ? 'Hide' : 'Show';
        });

        // ★ ファイル選択
        document.getElementById('selectFileBtn').onclick = () => {
            document.getElementById('fileInput').click();
        };

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            if (files.length > MAX_FILES) { 
                alert(`Max ${MAX_FILES} files`); 
                return; 
            }
            
            if (passwordProtectionEnabled && !currentPassword.trim()) {
                alert('Please enter a password');
                return;
            }
            
            await uploadMultiple(files, passwordProtectionEnabled ? currentPassword : null);
        });

        // ★ ボタンイベント
        document.getElementById('copyUrlBtn').onclick = async () => {
            const url = document.getElementById('shareUrl').value;
            await navigator.clipboard.writeText(url);
            document.getElementById('copyUrlBtn').textContent = 'Copied!';
            setTimeout(() => { document.getElementById('copyUrlBtn').textContent = 'Copy Link'; }, 2000);
        };

        document.getElementById('uploadMoreBtn').onclick = () => { 
            showUpload(); 
            document.getElementById('fileInput').value = ''; 
            document.getElementById('passwordToggle').classList.remove('active');
            document.getElementById('passwordInputGroup').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        };

        document.getElementById('openLinkBtn').onclick = () => 
            window.open(document.getElementById('shareUrl').value);

        document.getElementById('retryBtn').onclick = () => { 
            showUpload(); 
            document.getElementById('fileInput').value = ''; 
        };

        document.getElementById('backBtn').onclick = () => showUpload();

        // ★ ホームボタンのクリックイベント
        document.getElementById('homeBtn').onclick = () => {
            console.log('[HOME] Returning to home');
            showUpload();
            // ファイルインプットをリセット
            document.getElementById('fileInput').value = '';
            // パスワード関連をリセット
            document.getElementById('passwordToggle').classList.remove('active');
            document.getElementById('passwordInputGroup').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        };

        /**
         * ★ GitHubUploader クラス
         */
        class GitHubUploader {
            constructor() {
                this.functionUrl = '/.netlify/functions/github-upload';
            }

            async createRelease(releaseTag, fileName) {
                try {
                    const response = await fetch(this.functionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'create-release',
                            releaseTag: releaseTag,
                            metadata: { title: fileName }
                        })
                    });

                    if (!response.ok) throw new Error(`Create release failed: ${response.status}`);
                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || 'Release creation failed');
                    return data.data;
                } catch (e) {
                    console.error('[RELEASE] Error:', e.message);
                    throw e;
                }
            }

            async uploadAssetBinary(uploadUrl, fileName, fileObject) {
                try {
                    if (!window.chunkedBinaryUploader) {
                        throw new Error('ChunkedBinaryUploader not initialized');
                    }

                    const result = await window.chunkedBinaryUploader.uploadAssetBinary(
                        uploadUrl,
                        fileName,
                        fileObject
                    );
                    return result;
                } catch (e) {
                    console.error('[UPLOAD_BINARY] Error:', e.message);
                    throw e;
                }
            }

            async addFileToGithubJson(fileData) {
                try {
                    const response = await fetch(this.functionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'add-file',
                            fileData: {
                                fileId: String(fileData.fileId),
                                fileName: String(fileData.fileName),
                                fileSize: Number(fileData.fileSize),
                                downloadUrl: String(fileData.downloadUrl),
                                passwordHash: fileData.passwordHash  // ★ パスワードハッシュを追加
                            }
                        })
                    });

                    if (!response.ok) throw new Error(`Add file failed: ${response.status}`);
                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || 'Add file failed');
                    return data.data;
                } catch (e) {
                    console.error('[ADD_FILE] Error:', e.message);
                    throw e;
                }
            }
        }

        /**
         * ★ アップロード処理（100MB制限チェック付き）
         */
        async function uploadMultiple(files, password) {
            showStatus();
            const uploader = new GitHubUploader();
            const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

            try {
                console.log('[UPLOAD] START - Files:', files.length);

                // ★ ファイルサイズの検証
                console.log('[UPLOAD] Validating file sizes...');
                for (let idx = 0; idx < files.length; idx++) {
                    const file = files[idx];
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    
                    if (file.size > MAX_FILE_SIZE) {
                        const maxMB = (MAX_FILE_SIZE / 1024 / 1024).toFixed(0);
                        const errorMsg = `File "${file.name}" is too large: ${fileSizeMB}MB (max ${maxMB}MB per file)`;
                        console.error('[UPLOAD] ' + errorMsg);
                        throw new Error(errorMsg);
                    }
                    
                    console.log(`[UPLOAD] File ${idx + 1}: "${file.name}" - ${fileSizeMB}MB ✓`);
                }

                let passwordHash = null;
                if (password) {
                    passwordHash = await sha256(password);
                    console.log('[UPLOAD] Password hash:', passwordHash.substring(0, 16) + '...');
                }

                const fileIds = [];
                
                // ★ プログレス初期化
                document.getElementById('statusMessage').textContent = `0 / ${files.length} files`;
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressPercent').textContent = '0%';

                // ★ シーケンシャル: 1つずつアップロード
                for (let idx = 0; idx < files.length; idx++) {
                    const file = files[idx];
                    const fileInfo = await getUnifiedFileInfo(file);
                    const fileId = 'f_' + Math.random().toString(36).substr(2, 9);
                    const fileName = fileInfo.name;
                    const releaseTag = `file_${fileId}`;
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);

                    console.log(`[FILE_${idx}] Starting: "${fileName}" (${fileSizeMB}MB)`);
                    console.log(`[FILE_${idx}] Creating release...`);
                    const release = await uploader.createRelease(releaseTag, fileName);

                    console.log(`[FILE_${idx}] Uploading binary...`);
                    const assetData = await uploader.uploadAssetBinary(release.upload_url, fileName, file);

                    console.log(`[FILE_${idx}] Saving to shard...`);
                    const saveRes = await uploader.addFileToGithubJson({
                        fileId: fileId,
                        fileName: fileName,
                        fileSize: assetData.size,
                        downloadUrl: assetData.browser_download_url,
                        passwordHash: passwordHash
                    });

                    fileIds.push(fileId);
                    
                    // ★ プログレスバーを更新
                    const progress = Math.round(((idx + 1) / files.length) * 100);
                    document.getElementById('statusMessage').textContent = `${idx + 1} / ${files.length} files`;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressPercent').textContent = progress + '%';

                    console.log(`[FILE_${idx}] Complete - "${fileName}"`);
                }

                // ★ 複数ファイル時はグループを作成（修正版 - デバッグ強化）
                let shareUrl = '';
                
                if (fileIds.length > 1) {
                    console.log('[UPLOAD] Creating group for', fileIds.length, 'files');
                    const groupId = 'g_' + Math.random().toString(36).substr(2, 9);
                    console.log('[UPLOAD] Generated groupId:', groupId);
                    console.log('[UPLOAD] fileIds:', fileIds);
                    
                    try {
                        const functionUrl = '/.netlify/functions/github-upload';
                        console.log('[UPLOAD] Sending group creation request to:', functionUrl);
                        
                        const groupRes = await fetch(functionUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'create-group',
                                groupId: groupId,
                                fileIds: fileIds,
                                passwordHash: passwordHash
                            })
                        });

                        console.log('[UPLOAD] Group creation response status:', groupRes.status);
                        
                        if (groupRes.ok) {
                            const groupData = await groupRes.json();
                            console.log('[UPLOAD] Group created successfully:', groupId);
                            shareUrl = `https://avfile.io/d/${groupId}`;
                        } else {
                            const errText = await groupRes.text();
                            console.warn('[UPLOAD] Group creation failed:', groupRes.status, errText);
                            shareUrl = `https://avfile.io/d/${fileIds.join(',')}`;
                        }
                    } catch (e) {
                        console.error('[UPLOAD] Group creation error:', e.message);
                        shareUrl = `https://avfile.io/d/${fileIds.join(',')}`;
                    }
                } else {
                    // 単一ファイル
                    console.log('[UPLOAD] Single file - no group needed');
                    shareUrl = `https://avfile.io/d/${fileIds[0]}`;
                }
                
                console.log('[UPLOAD] SUCCESS - Share URL:', shareUrl);
                document.getElementById('shareUrl').value = shareUrl;

                const passwordStatusBox = document.getElementById('passwordStatusBox');
                if (password) {
                    passwordStatusBox.style.display = 'block';
                } else {
                    passwordStatusBox.style.display = 'none';
                }

                console.log('[UPLOAD] SUCCESS - All files uploaded:', fileIds);
                showSuccess();
            } catch (e) {
                console.error('[UPLOAD] FAILED:', e.message);
                showError(e.message);
            }
        }

        /**
         * ★ カルーセルクラス
         */
        class Carousel {
            constructor(track, dots, prevBtn, nextBtn, info) {
                this.track = track;
                this.dots = dots;
                this.prevBtn = prevBtn;
                this.nextBtn = nextBtn;
                this.info = info;
                this.current = 0;
                this.count = 0;

                prevBtn.addEventListener('click', () => this.prev());
                nextBtn.addEventListener('click', () => this.next());
            }

            addItem(el) {
                this.track.appendChild(el);
                this.count++;
                const dot = document.createElement('button');
                dot.className = `dot ${this.count === 1 ? 'active' : ''}`;
                dot.onclick = () => this.goTo(this.count - 1);
                this.dots.appendChild(dot);
                this.update();
            }

            next() {
                if (this.current < this.count - 1) {
                    this.current++;
                    this.update();
                }
            }

            prev() {
                if (this.current > 0) {
                    this.current--;
                    this.update();
                }
            }

            goTo(i) {
                if (i >= 0 && i < this.count) {
                    this.current = i;
                    this.update();
                }
            }

            update() {
                this.track.style.transform = `translateX(${-this.current * 100}%)`;
                document.querySelectorAll('.dot').forEach((d, i) => {
                    d.classList.toggle('active', i === this.current);
                });
                this.info.textContent = `${this.current + 1} / ${this.count}`;
                this.prevBtn.disabled = this.current === 0;
                this.nextBtn.disabled = this.current === this.count - 1;
            }
        }

        /**
         * ★ URLからviewIdを取得（複数ID対応）
         */
        function getViewIdFromPath() {
            const pathname = location.pathname || '';
            // ★ コンマ区切りの複数IDにも対応
            let match = pathname.match(/\/d\/([a-zA-Z0-9_,-]+)/i);
            if (match) return match[1];
            
            const params = new URLSearchParams(location.search);
            if (params.has('id')) return params.get('id');
            if (params.has('view')) return params.get('view');
            
            const hash = location.hash.replace('#', '').split('?')[0];
            if (hash && hash.length > 0) return hash;
            
            return null;
        }

        const viewId = getViewIdFromPath();
        // ★ 複数IDをコンマで分割
        const viewIds = viewId ? viewId.split(',').map(id => id.trim()) : [];
        console.log('[INIT] viewIds:', viewIds);

        /**
         * ★ ファイルビューアー（パスワード保護対応・複数ファイル対応）
         */
        async function loadView(viewIds) {
            try {
                console.log('[MAIN] Loading views:', viewIds);

                // ★ 複数IDのファイルを全て取得
                let allFiles = [];
                
                for (const singleId of viewIds) {
                    try {
                        console.log(`[MAIN] Loading file ${singleId}...`);
                        const filesRes = await fetch(`/.netlify/functions/view?id=${singleId}`);
                        console.log(`[MAIN] File ${singleId} response status:`, filesRes.status);
                        
                        // ★ パスワード保護されている場合
                        if (filesRes.status === 403) {
                            const errorData = await filesRes.json();
                            console.log('[MAIN] Password required:', errorData);
                            
                            if (errorData.requiresPassword) {
                                // パスワード入力ダイアログを表示
                                showPasswordPrompt(singleId);
                                return;
                            }
                        }
                        
                        if (!filesRes.ok) {
                            const errorText = await filesRes.text();
                            console.error(`[MAIN] File ${singleId} error:`, errorText);
                            continue; // 次のファイルへ
                        }

                        const filesData = await filesRes.json();
                        const fileList = filesData.files || [];
                        console.log(`[MAIN] File ${singleId} loaded:`, fileList.length, 'files');
                        
                        allFiles = allFiles.concat(fileList);
                    } catch (e) {
                        console.error(`[MAIN] Error loading file ${singleId}:`, e.message);
                        continue;
                    }
                }

                console.log('[MAIN] Total files loaded:', allFiles.length);

                if (!allFiles || allFiles.length === 0) {
                    throw new Error('No files found');
                }

                const carousel = new Carousel(
                    document.getElementById('carouselTrack'),
                    document.getElementById('carouselDots'),
                    document.getElementById('prevBtn'),
                    document.getElementById('nextBtn'),
                    document.getElementById('slideInfo')
                );

                for (let fileIndex = 0; fileIndex < allFiles.length; fileIndex++) {
                    const file = allFiles[fileIndex];
                    const item = document.createElement('div');
                    item.className = 'carousel-item';

                    const ext = file.fileName.split('.').pop().toLowerCase();
                    const fileName = escapeHtml(file.fileName);
                    const downloadUrl = escapeHtml(file.downloadUrl);
                    const fileSize = formatSize(file.fileSize || 0);
                    const proxyUrl = `/.netlify/functions/proxy-download?url=${encodeURIComponent(file.downloadUrl)}`;
                    const proxyUrlEscaped = escapeHtml(proxyUrl);
                    const encodedUrl = encodeURIComponent(file.downloadUrl);

                    let preview = '';
                    let fileTypeDetected = 'unknown';

                    // ★ MOVファイルは非表示でフォルダアイコンを表示
                    if (ext.match(/^mov$/i)) {
                        fileTypeDetected = 'video';
                        console.log('[MAIN] ✓ MOV file detected - showing folder icon');
                        preview = `
                            <div class="file-preview-area">
                                <div class="folder-icon"></div>
                            </div>
                        `;
                    }
                    // 動画ファイル
                    else if (ext.match(/^(mp4|webm|ogg|mkv|avi|flv|wmv|m4v|ts|m2ts|mts|3gp|3g2)$/i)) {
                        fileTypeDetected = 'video';
                        console.log('[MAIN] ✓ Video file detected');
                        preview = `
                            <div class="file-preview-area">
                                <video controls style="max-width: 100%; max-height: 500px; border-radius: 8px;" crossorigin="anonymous">
                                    <source src="${proxyUrlEscaped}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        `;
                    }
                    // 画像ファイル
                    else if (ext.match(/^(jpg|jpeg|png|gif|webp|bmp|svg|ico|tiff|tif)$/i)) {
                        fileTypeDetected = 'image';
                        console.log('[MAIN] ✓ Image file detected');
                        preview = `
                            <div class="file-preview-area">
                                <img src="${proxyUrlEscaped}" style="max-width: 100%; max-height: 500px; border-radius: 8px;" alt="${fileName}" crossorigin="anonymous" />
                            </div>
                        `;
                    }
                    // PDF ファイル
                    else if (ext.match(/^pdf$/i)) {
                        fileTypeDetected = 'pdf';
                        console.log('[MAIN] ✓ PDF file detected');
                        preview = `
                            <div class="file-preview-area" style="flex-direction: column; gap: 1rem;">
                                <div style="font-size: 3rem;"></div>
                                <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 1rem;">PDF Document</p>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <a href="https://docs.google.com/viewer?url=${encodedUrl}&embedded=true" target="_blank" rel="noopener noreferrer">View in Google Docs</a>
                                    <a href="${downloadUrl}" download>Download PDF</a>
                                </div>
                            </div>
                        `;
                    }
                    // 音声ファイル
                    else if (ext.match(/^(mp3|wav|ogg|flac|m4a|aac|wma|opus)$/i)) {
                        fileTypeDetected = 'audio';
                        console.log('[MAIN] ✓ Audio file detected');
                        preview = `
                            <div class="file-preview-area" style="flex-direction: column; gap: 1rem;">
                                <div style="font-size: 4rem;">AUDIO</div>
                                <audio controls style="width: 100%; max-width: 500px;" crossorigin="anonymous">
                                    <source src="${proxyUrlEscaped}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <p style="color: rgba(255, 255, 255, 0.7);">Audio file: ${fileName}</p>
                            </div>
                        `;
                    }
                    // その他ファイル
                    else {
                        fileTypeDetected = 'unknown';
                        preview = `
                            <div class="file-preview-area" style="flex-direction: column; gap: 1rem;">
                                <div style="font-size: 3rem;">FILE</div>
                                <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 1rem;">File (${ext.toUpperCase()})</p>
                                <a href="${downloadUrl}" download>Download file</a>
                            </div>
                        `;
                    }

                    item.innerHTML = `
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div class="file-item-header">
                                <div class="file-item-info">
                                    <div class="file-icon">${getIcon(file.fileName)}</div>
                                    <div class="file-details">
                                        <h3>${fileName}</h3>
                                        <p>${fileSize}</p>
                                        <p style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">Type: ${fileTypeDetected} | Ext: ${ext}</p>
                                    </div>
                                </div>
                                <div class="file-item-actions">
                                    <a href="${downloadUrl}" download class="file-action-btn">Download</a>
                                    <button class="file-action-btn" onclick="navigator.clipboard.writeText('${downloadUrl}'); this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy Link', 2000);">Copy Link</button>
                                </div>
                            </div>
                            ${preview}
                        </div>
                    `;

                    carousel.addItem(item);
                }

                hideAll();
                document.getElementById('fileViewerContainer').classList.add('show');

            } catch (e) {
                console.error('[MAIN] Error:', e.message);
                showError('File not found: ' + e.message);
            }
        }

        /**
         * ★ パスワード入力プロンプト
         */
        function showPasswordPrompt(viewId) {
            const password = prompt('[LOCK] This file is password protected.\n\nPlease enter the password:');
            
            if (password === null) {
                console.log('[PASSWORD] User cancelled');
                showError('Password required to access this file');
                return;
            }

            if (password.trim() === '') {
                console.log('[PASSWORD] Empty password');
                showError('Password cannot be empty');
                return;
            }

            // パスワードをハッシュ化
            sha256(password).then(hash => {
                console.log('[PASSWORD] Hash calculated:', hash.substring(0, 16) + '...');
                // パスワードハッシュをクエリパラメータに追加
                loadViewWithPassword(viewId, hash);
            }).catch(e => {
                console.error('[PASSWORD] Hashing error:', e.message);
                showError('Error processing password');
            });
        }

        /**
         * ★ パスワード付きでファイルを読み込む
         */
        async function loadViewWithPassword(viewId, passwordHash) {
            try {
                console.log('[MAIN] Loading view with password:', viewId);

                const filesRes = await fetch(`/.netlify/functions/view?id=${viewId}&pwd=${passwordHash}`);
                console.log('[MAIN] Files response status:', filesRes.status);
                
                if (!filesRes.ok) {
                    const errorData = await filesRes.json();
                    console.error('[MAIN] Files error:', errorData);
                    
                    if (filesRes.status === 403) {
                        showError('Invalid password');
                        showPasswordPrompt(viewId);
                        return;
                    }
                    
                    throw new Error(`Failed to load files: ${filesRes.status}`);
                }

                const filesData = await filesRes.json();
                const allFiles = filesData.files || [];
                console.log('[MAIN] All files:', allFiles);

                if (!allFiles || allFiles.length === 0) {
                    throw new Error('No files found');
                }

                // ファイル表示処理（上記のloadViewと同じ）
                const carousel = new Carousel(
                    document.getElementById('carouselTrack'),
                    document.getElementById('carouselDots'),
                    document.getElementById('prevBtn'),
                    document.getElementById('nextBtn'),
                    document.getElementById('slideInfo')
                );

                for (let fileIndex = 0; fileIndex < allFiles.length; fileIndex++) {
                    const file = allFiles[fileIndex];
                    const item = document.createElement('div');
                    item.className = 'carousel-item';

                    const ext = file.fileName.split('.').pop().toLowerCase();
                    const fileName = escapeHtml(file.fileName);
                    const downloadUrl = escapeHtml(file.downloadUrl);
                    const fileSize = formatSize(file.fileSize || 0);
                    const proxyUrl = `/.netlify/functions/proxy-download?url=${encodeURIComponent(file.downloadUrl)}`;
                    const proxyUrlEscaped = escapeHtml(proxyUrl);
                    const encodedUrl = encodeURIComponent(file.downloadUrl);

                    let preview = '';
                    let fileTypeDetected = 'unknown';

                    // ★ MOVファイルは非表示でフォルダアイコンを表示
                    if (ext.match(/^mov$/i)) {
                        fileTypeDetected = 'video';
                        preview = `
                            <div class="file-preview-area">
                                <div class="folder-icon"></div>
                            </div>
                        `;
                    }
                    // 動画ファイル
                    else if (ext.match(/^(mp4|webm|ogg|mkv|avi|flv|wmv|m4v|ts|m2ts|mts|3gp|3g2)$/i)) {
                        fileTypeDetected = 'video';
                        preview = `
                            <div class="file-preview-area">
                                <video controls style="max-width: 100%; max-height: 500px; border-radius: 8px;" crossorigin="anonymous">
                                    <source src="${proxyUrlEscaped}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        `;
                    }
                    // 画像ファイル
                    else if (ext.match(/^(jpg|jpeg|png|gif|webp|bmp|svg|ico|tiff|tif)$/i)) {
                        fileTypeDetected = 'image';
                        preview = `
                            <div class="file-preview-area">
                                <img src="${proxyUrlEscaped}" style="max-width: 100%; max-height: 500px; border-radius: 8px;" alt="${fileName}" crossorigin="anonymous" />
                            </div>
                        `;
                    }
                    // PDF ファイル
                    else if (ext.match(/^pdf$/i)) {
                        fileTypeDetected = 'pdf';
                        preview = `
                            <div class="file-preview-area" style="flex-direction: column; gap: 1rem;">
                                <div style="font-size: 3rem;"></div>
                                <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 1rem;">PDF Document</p>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <a href="https://docs.google.com/viewer?url=${encodedUrl}&embedded=true" target="_blank" rel="noopener noreferrer">View in Google Docs</a>
                                    <a href="${downloadUrl}" download>Download PDF</a>
                                </div>
                            </div>
                        `;
                    }
                    // 音声ファイル
                    else if (ext.match(/^(mp3|wav|ogg|flac|m4a|aac|wma|opus)$/i)) {
                        fileTypeDetected = 'audio';
                        preview = `
                            <div class="file-preview-area" style="flex-direction: column; gap: 1rem;">
                                <div style="font-size: 4rem;">AUDIO</div>
                                <audio controls style="width: 100%; max-width: 500px;" crossorigin="anonymous">
                                    <source src="${proxyUrlEscaped}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <p style="color: rgba(255, 255, 255, 0.7);">Audio file: ${fileName}</p>
                            </div>
                        `;
                    }
                    // その他ファイル
                    else {
                        fileTypeDetected = 'unknown';
                        preview = `
                            <div class="file-preview-area" style="flex-direction: column; gap: 1rem;">
                                <div style="font-size: 3rem;">FILE</div>
                                <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 1rem;">File (${ext.toUpperCase()})</p>
                                <a href="${downloadUrl}" download>Download file</a>
                            </div>
                        `;
                    }

                    item.innerHTML = `
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div class="file-item-header">
                                <div class="file-item-info">
                                    <div class="file-icon">${getIcon(file.fileName)}</div>
                                    <div class="file-details">
                                        <h3>${fileName}</h3>
                                        <p>${fileSize}</p>
                                        <p style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">Type: ${fileTypeDetected} | Ext: ${ext}</p>
                                    </div>
                                </div>
                                <div class="file-item-actions">
                                    <a href="${downloadUrl}" download class="file-action-btn">Download</a>
                                    <button class="file-action-btn" onclick="navigator.clipboard.writeText('${downloadUrl}'); this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy Link', 2000);">Copy Link</button>
                                </div>
                            </div>
                            ${preview}
                        </div>
                    `;

                    carousel.addItem(item);
                }

                hideAll();
                document.getElementById('fileViewerContainer').classList.add('show');

            } catch (e) {
                console.error('[MAIN] Error:', e.message);
                showError('File not found: ' + e.message);
            }
        }

        // ★ 初期化
        if (viewIds && viewIds.length > 0) {
            showLoading();
            loadView(viewIds);
        } else {
            showUpload();
        }
    </script>
</body>
</html>