<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avfile - Fast File Sharing</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <link rel="icon" type="image/png" href="/images/folder.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%); color: #e0e0e0; min-height: 100vh; }
        .navbar { background: rgba(15, 15, 30, 0.95); backdrop-filter: blur(10px); padding: 1rem 2rem; border-bottom: 1px solid rgba(102, 126, 234, 0.2); position: sticky; top: 0; z-index: 100; }
        .navbar-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; }
        .hero { padding: 4rem 0; text-align: center; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .hero-desc { font-size: 1.1rem; color: #b0b0b0; margin-bottom: 2rem; }
        .upload-section { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 16px; padding: 3rem; margin: 3rem 0; }
        .upload-area { border: 2px dashed rgba(102, 126, 234, 0.5); border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.3s; min-height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .upload-area:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
        .upload-area.drag-over { border-color: #667eea; background: rgba(102, 126, 234, 0.15); }
        .upload-area h2 { font-size: 1.3rem; margin-bottom: 0.5rem; }
        .upload-area p { color: #909090; font-size: 0.95rem; }
        input[type="file"] { display: none; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: all 0.3s; margin-top: 1rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .upload-status-screen { display: none; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 16px; padding: 4rem 2rem; margin: 3rem 0; text-align: center; }
        .upload-status-screen.show { display: block; }
        .upload-status-spinner { width: 60px; height: 60px; border: 4px solid rgba(102, 126, 234, 0.2); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .upload-status-title { font-size: 1.8rem; font-weight: bold; color: #667eea; margin-bottom: 0.5rem; }
        .upload-status-message { font-size: 1rem; color: #e0e0e0; margin-bottom: 0.5rem; }
        .upload-status-file { font-size: 0.95rem; color: #909090; margin-bottom: 2rem; }
        .upload-progress-bar { width: 100%; max-width: 500px; height: 14px; background: rgba(102, 126, 234, 0.2); border-radius: 7px; overflow: hidden; border: 1px solid rgba(102, 126, 234, 0.3); margin: 0 auto 0.8rem; }
        .upload-progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.4s ease; }
        .upload-progress-text { font-size: 1.1rem; font-weight: bold; color: #667eea; }
        .success-screen { display: none; background: rgba(76, 175, 80, 0.08); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 16px; padding: 4rem 2rem; margin: 3rem 0; text-align: center; }
        .success-screen.show { display: block; }
        .success-icon { font-size: 4rem; color: #4caf50; margin-bottom: 1.5rem; }
        .success-title { font-size: 1.8rem; font-weight: bold; color: #4caf50; margin-bottom: 0.5rem; }
        .success-message { font-size: 1rem; color: #b0b0b0; margin-bottom: 2rem; }
        .share-url-box { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .share-url-label { font-size: 0.9rem; color: #909090; margin-bottom: 0.8rem; }
        .share-url-input-group { display: flex; gap: 0.5rem; flex-direction: column; }
        @media (min-width: 600px) { .share-url-input-group { flex-direction: row; } }
        .share-url-input { flex: 1; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 0.8rem; color: #e0e0e0; font-size: 0.9rem; word-break: break-all; }
        .copy-btn { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; white-space: nowrap; }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3); }
        .success-actions { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; }
        .action-button { background: rgba(102, 126, 234, 0.15); border: 1px solid rgba(102, 126, 234, 0.3); color: #667eea; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: all 0.3s; }
        .action-button:hover { background: rgba(102, 126, 234, 0.25); }
        .error-screen { display: none; background: rgba(255, 107, 107, 0.08); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 16px; padding: 4rem 2rem; margin: 3rem 0; text-align: center; }
        .error-screen.show { display: block; }
        .error-icon { font-size: 4rem; color: #ff6b6b; margin-bottom: 1.5rem; }
        .error-title { font-size: 1.8rem; font-weight: bold; color: #ff6b6b; margin-bottom: 0.5rem; }
        .error-message { font-size: 1rem; color: #b0b0b0; margin-bottom: 2rem; word-break: break-word; }
        .error-btn { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .error-btn:hover { transform: translateY(-2px); }
        .file-viewer-container { display: none; background: rgba(102, 126, 234, 0.08); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 2rem; margin: 2rem 0; }
        .file-viewer-container.show { display: block; }
        .file-viewer { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 2rem; margin: 2rem 0; }
        .file-viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(102, 126, 234, 0.2); flex-wrap: wrap; gap: 1rem; }
        .file-info { display: flex; align-items: center; gap: 1rem; }
        .file-icon { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(102, 126, 234, 0.15); border-radius: 8px; font-size: 1.5rem; }
        .file-details h3 { font-size: 1.1rem; color: #667eea; margin-bottom: 0.3rem; word-break: break-word; }
        .file-details p { font-size: 0.85rem; color: #909090; }
        .file-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .file-action-btn { background: rgba(102, 126, 234, 0.15); border: 1px solid rgba(102, 126, 234, 0.3); color: #667eea; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .file-action-btn:hover { background: rgba(102, 126, 234, 0.25); }
        .file-preview { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 2rem; margin-top: 1.5rem; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 300px; }
        .file-preview video, .file-preview img { max-width: 100%; max-height: 600px; border-radius: 8px; }
        .file-preview p { color: #ff6b6b; }
        .footer { margin-top: 4rem; padding: 2rem; border-top: 1px solid rgba(102, 126, 234, 0.2); text-align: center; color: #707070; font-size: 0.9rem; }
        @media (max-width: 768px) { .hero h1 { font-size: 1.8rem; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">Avfile</div>
        </div>
    </nav>

    <main class="container">
        <section class="hero">
            <h1>Fast & Simple File Sharing</h1>
            <p class="hero-desc">Upload your files and get a shareable link instantly.</p>
        </section>

        <div id="mainContainer">
            <section class="upload-section" id="uploadUI">
                <div class="upload-area" id="uploadArea">
                    <h2>Drop Files or Click to Upload</h2>
                    <p>Upload up to 5 files at once</p>
                    <input type="file" id="fileInput" multiple accept="*/*" />
                    <button class="btn" id="selectFileBtn">Select Files</button>
                </div>
            </section>

            <div class="upload-status-screen" id="uploadStatusScreen">
                <div class="upload-status-spinner"></div>
                <div class="upload-status-title" id="statusTitle">Uploading...</div>
                <div class="upload-status-message" id="statusMessage">0 / 0 files</div>
                <div class="upload-status-file" id="statusFileName">file.txt</div>
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill" id="progressFill"></div>
                </div>
                <div class="upload-progress-text" id="progressPercent">0%</div>
            </div>

            <div class="success-screen" id="successScreen">
                <div class="success-icon">âœ“</div>
                <div class="success-title">Upload Complete!</div>
                <div class="success-message">Your files are ready to share</div>
                <div class="share-url-box">
                    <div class="share-url-label">Share this link:</div>
                    <div class="share-url-input-group">
                        <input type="text" id="shareUrl" readonly class="share-url-input" />
                        <button class="copy-btn" id="copyUrlBtn">Copy Link</button>
                    </div>
                </div>
                <div class="success-actions">
                    <button class="action-button" id="uploadMoreBtn">Upload More</button>
                    <button class="action-button" id="openLinkBtn">Open Link</button>
                </div>
            </div>

            <div class="error-screen" id="errorScreen">
                <div class="error-icon">âœ—</div>
                <div class="error-title">Upload Failed</div>
                <div class="error-message" id="errorMsg"></div>
                <button class="error-btn" id="retryBtn">Try Again</button>
            </div>

            <div class="file-viewer-container" id="fileViewerContainer">
                <div id="fileViewer"></div>
            </div>

            <div style="display: none; text-align: center; padding: 4rem;" id="loadingUI">
                <div class="upload-status-spinner"></div>
                <p style="margin-top: 1rem; color: #909090;">Loading files...</p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Avfile â€¢ Fast File Sharing</p>
    </footer>

<script>
// ===== GITHUB UPLOADER =====
class GitHubUploader {
  constructor() {
    this.functionUrl = '/.netlify/functions/github-upload';
  }

  async createRelease(releaseTag, fileName, description) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create-release',
        releaseTag: releaseTag,
        metadata: { title: fileName, description: description },
      }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Release failed');
    return data.data;
  }

  async uploadAsset(uploadUrl, fileName, base64Data, fileId, fileSize) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'upload-asset',
        uploadUrl: uploadUrl,
        fileName: fileName,
        fileBase64: base64Data,
        fileId,
        fileSize,
      }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Upload failed');
    return data.data;
  }

  async getGithubJson() {
    try {
      const response = await fetch(this.functionUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'get-github-json' }),
      });
      const data = await response.json();
      return data.success ? data.data : { files: [], views: [] };
    } catch {
      return { files: [], views: [] };
    }
  }

  async saveGithubJson(jsonData) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'save-github-json', jsonData: jsonData }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Save failed');
    return data.data;
  }

  async createView(fileIds, origin) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create-view',
        fileIds,
        passwordHash: null,
        origin: origin || window.location.origin
      })
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'View creation failed');
    return data.data;
  }
}

class SimpleUploadManager {
  constructor() {
    this.githubUploader = new GitHubUploader();
  }

  generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16);
    });
  }

  async fileToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  async uploadFile(fileBlob, fileName, onProgress = () => {}) {
    try {
      const fileId = this.generateUUID();
      const base64 = await this.fileToBase64(fileBlob);
      const releaseTag = `file_${fileId}`;

      onProgress(20);
      const releaseData = await this.githubUploader.createRelease(releaseTag, fileName, `File: ${fileName}`);

      onProgress(60);
      const assetData = await this.githubUploader.uploadAsset(
        releaseData.upload_url,
        fileName,
        base64,
        fileId,
        fileBlob.size
      );

      onProgress(80);
      const res = await this.githubUploader.getGithubJson();
      const githubJson = res;
      githubJson.files = Array.isArray(githubJson.files) ? githubJson.files : [];

      const shareUrl = `${window.location.origin}/d/${fileId}`;

      githubJson.files.push({
        fileId: fileId,
        fileName: fileName,
        downloadUrl: assetData.download_url,
        shareUrl: shareUrl,
        fileSize: fileBlob.size,
        uploadedAt: new Date().toISOString(),
      });

      await this.githubUploader.saveGithubJson(githubJson);

      onProgress(100);
      return { fileId, fileName, downloadUrl: assetData.download_url, shareUrl: shareUrl };
    } catch (error) {
      console.error('Upload error:', error);
      throw error;
    }
  }

  async uploadMultiple(files) {
    const fileIds = [];
    for (const file of files) {
      const result = await this.uploadFile(file, file.name, () => {});
      fileIds.push(result.fileId);
    }
    return await this.githubUploader.createView(fileIds, window.location.origin);
  }
}

// ===== APP =====
const MAX_FILES = 5;
const pathMatch = location.pathname.match(/^\/d\/([a-zA-Z0-9]+)/);
const viewId = pathMatch?.[1] || null;

console.log('[APP] Initialized - viewId:', viewId);

function hideAllScreens() {
  document.getElementById('uploadUI').style.display = 'none';
  document.getElementById('uploadStatusScreen').classList.remove('show');
  document.getElementById('successScreen').classList.remove('show');
  document.getElementById('errorScreen').classList.remove('show');
  document.getElementById('fileViewerContainer').classList.remove('show');
  document.getElementById('loadingUI').style.display = 'none';
}

function showUploadUI() { hideAllScreens(); document.getElementById('uploadUI').style.display = 'block'; }
function showUploadStatus() { hideAllScreens(); document.getElementById('uploadStatusScreen').classList.add('show'); }
function showSuccessScreen() { hideAllScreens(); document.getElementById('successScreen').classList.add('show'); }
function showErrorScreen(msg) { 
  hideAllScreens(); 
  document.getElementById('errorMsg').textContent = msg; 
  document.getElementById('errorScreen').classList.add('show'); 
}
function showLoadingUI() { hideAllScreens(); document.getElementById('loadingUI').style.display = 'block'; }

// ===== FILE INPUT HANDLERS =====
document.getElementById('selectFileBtn').onclick = () => {
  console.log('[UI] Select button clicked');
  document.getElementById('fileInput').click();
};

const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');

// â˜… ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠžæ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
fileInput.addEventListener('change', async (e) => {
  console.log('[FILE] Changed - files count:', e.target.files.length);
  
  try {
    // â˜… Array.from() ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    const files = Array.from(e.target.files);
    
    if (!files.length) {
      console.log('[FILE] No files selected');
      return;
    }

    console.log('[FILE] Selected files:', files.map(f => f.name).join(', '));

    if (files.length > MAX_FILES) {
      alert(`Max ${MAX_FILES} files allowed`);
      fileInput.value = '';  // â˜… ãƒªã‚»ãƒƒãƒˆ
      return;
    }

    await uploadMultiple(files);
  } catch (error) {
    console.error('[ERROR] File input handler:', error);
    showErrorScreen(error.message || 'Failed to process files');
  }
}, false);

// ===== DRAG & DROP =====
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  e.stopPropagation();
  uploadArea.classList.add('drag-over');
}, false);

uploadArea.addEventListener('dragleave', (e) => {
  e.preventDefault();
  e.stopPropagation();
  uploadArea.classList.remove('drag-over');
}, false);

uploadArea.addEventListener('drop', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  uploadArea.classList.remove('drag-over');
  
  console.log('[DROP] Dropped - files count:', e.dataTransfer.files.length);
  
  try {
    // â˜… Array.from() ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    const files = Array.from(e.dataTransfer.files);
    
    if (files.length > MAX_FILES) {
      alert(`Max ${MAX_FILES} files allowed`);
      return;
    }

    await uploadMultiple(files);
  } catch (error) {
    console.error('[ERROR] Drop handler:', error);
    showErrorScreen(error.message || 'Drop failed');
  }
}, false);

// ===== BUTTONS =====
document.getElementById('copyUrlBtn').onclick = async () => {
  const url = document.getElementById('shareUrl').value;
  try {
    await navigator.clipboard.writeText(url);
    document.getElementById('copyUrlBtn').textContent = 'Copied!';
    setTimeout(() => { document.getElementById('copyUrlBtn').textContent = 'Copy Link'; }, 2000);
  } catch (error) {
    console.error('[ERROR] Copy failed:', error);
    alert('Copy failed');
  }
};

document.getElementById('uploadMoreBtn').onclick = () => {
  console.log('[UI] Upload more clicked');
  showUploadUI();
  fileInput.value = '';
};

document.getElementById('openLinkBtn').onclick = () => {
  const url = document.getElementById('shareUrl').value;
  console.log('[UI] Opening link:', url);
  window.open(url, '_blank');
};

document.getElementById('retryBtn').onclick = () => {
  console.log('[UI] Retry clicked');
  showUploadUI();
  fileInput.value = '';
};

// ===== UPLOAD FUNCTION =====
async function uploadMultiple(files) {
  console.log('[UPLOAD] Starting - files count:', files.length);
  
  showUploadStatus();
  const uploadManager = new SimpleUploadManager();
  const uploadedIds = [];
  
  try {
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      console.log(`[UPLOAD] Processing file ${i + 1}/${files.length}:`, file.name);
      
      document.getElementById('statusMessage').textContent = `${i + 1} / ${files.length}`;
      document.getElementById('statusFileName').textContent = file.name;

      const result = await uploadManager.uploadFile(file, file.name, (progress) => {
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
      });

      console.log(`[UPLOAD] File uploaded:`, result.fileId);
      uploadedIds.push(result.fileId);
    }

    console.log('[UPLOAD] All files uploaded - creating view');
    
    const view = await uploadManager.githubUploader.createView(uploadedIds, window.location.origin);
    
    console.log('[UPLOAD] View created:', view.viewId);
    
    document.getElementById('shareUrl').value = view.shareUrl;
    showSuccessScreen();
    
  } catch (error) {
    console.error('[ERROR] Upload failed:', error);
    showErrorScreen(error.message || 'Upload failed');
  }
}

// ===== VIEW LOADING =====
async function loadAndDisplayView(viewId) {
  console.log('[VIEW] Loading view:', viewId);
  
  try {
    const res = await fetch(`/.netlify/functions/view?id=${viewId}`);
    
    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    
    const data = await res.json();
    console.log('[VIEW] Data received:', data);

    let html = '';
    
    for (const file of data.files || []) {
      const url = file.downloadUrl;
      let preview = '';

      if (/\.(mp4|webm|ogg)$/i.test(file.fileName)) {
        preview = `<div class="file-preview"><video controls style="max-width: 100%; max-height: 500px;"><source src="${url}"></video></div>`;
      } else if (/\.(jpg|jpeg|png|gif|webp)$/i.test(file.fileName)) {
        preview = `<div class="file-preview"><img src="${url}" style="max-width: 100%; max-height: 500px;" /></div>`;
      } else if (/\.(pdf)$/i.test(file.fileName)) {
        preview = `<div class="file-preview"><iframe src="${url}" style="width: 100%; height: 500px;"></iframe></div>`;
      }

      html += `<div class="file-viewer">
        <div class="file-viewer-header">
          <div class="file-info">
            <div class="file-icon">ðŸ“„</div>
            <div class="file-details">
              <h3>${file.fileName}</h3>
              <p>${(file.fileSize / 1024 / 1024).toFixed(2)} MB</p>
            </div>
          </div>
          <div class="file-actions">
            <a href="${url}" download class="file-action-btn">ðŸ“¥ Download</a>
            <button class="file-action-btn" onclick="navigator.clipboard.writeText('${url}'); this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy Link', 2000);">ðŸ”— Copy Link</button>
          </div>
        </div>
        ${preview}
      </div>`;
    }

    document.getElementById('fileViewer').innerHTML = html;
    hideAllScreens();
    document.getElementById('fileViewerContainer').classList.add('show');
    
  } catch (error) {
    console.error('[ERROR] View error:', error);
    showErrorScreen('File not found: ' + error.message);
  }
}

// ===== INIT =====
if (viewId) {
  console.log('[INIT] View mode - loading view:', viewId);
  showLoadingUI();
  loadAndDisplayView(viewId);
} else {
  console.log('[INIT] Upload mode');
  showUploadUI();
}
</script>

</body>
</html>