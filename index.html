<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avfile - Fast File Sharing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%); 
            color: #ffffff; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar { 
            background: rgba(15, 15, 30, 0.95); 
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .navbar-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .logo-container { 
            display: flex; 
            align-items: center; 
            gap: 1rem;
        }
        .logo-box {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .logo-text { 
            font-size: 1.5rem; 
            font-weight: 700;
            color: #ffffff;
        }
        .logo-tagline {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: -0.5rem;
        }

        .container { 
            flex: 1;
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 1rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #ffffff;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
            font-weight: 300;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 4rem 3rem;
            margin: 2rem 0;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.03);
        }

        .upload-area.drag-over {
            border-color: #ffffff;
            background: rgba(255, 255, 255, 0.08);
        }

        .upload-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .upload-area h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #ffffff;
            font-weight: 600;
        }

        .upload-area p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 1.5rem;
        }

        input[type="file"] { display: none; }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 0.9rem 2.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 1.5rem;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .features-section {
            margin-top: 6rem;
            padding: 3rem 2rem;
        }

        .features-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: #ffffff;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.8rem;
        }

        .feature-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }

        .upload-status-screen, .success-screen, .error-screen, .file-viewer-container, .loading-screen {
            display: none;
        }

        .upload-status-screen.show, .success-screen.show, .error-screen.show, 
        .file-viewer-container.show, .loading-screen.show {
            display: block;
        }

        .upload-status-screen, .error-screen {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 4rem 2rem;
            margin: 3rem 0;
            text-align: center;
        }

        .success-screen {
            background: rgba(76, 175, 80, 0.08);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 16px;
            padding: 4rem 2rem;
            margin: 3rem 0;
            text-align: center;
        }

        .error-screen {
            background: rgba(255, 107, 107, 0.08);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .status-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .success-screen .status-title { color: #4caf50; }
        .error-screen .status-title { color: #ff6b6b; }

        .success-icon { font-size: 4rem; margin-bottom: 1.5rem; }
        .error-icon { font-size: 4rem; margin-bottom: 1.5rem; }

        .share-url-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .share-url-input-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .share-url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            color: #ffffff;
            font-size: 0.9rem;
            word-break: break-all;
            min-width: 200px;
        }

        .copy-btn {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #ffffff;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .copy-btn:hover { 
            background: rgba(76, 175, 80, 0.5);
            transform: translateY(-2px); 
        }

        .action-button {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 0.5rem;
            transition: all 0.3s;
        }

        .action-button:hover { 
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .progress-bar {
            width: 100%;
            max-width: 500px;
            height: 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 7px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 0 auto 0.8rem;
        }

        .progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            width: 0%;
            transition: width 0.4s ease;
        }

        .carousel-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .carousel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .carousel-title {
            font-size: 1.3rem;
            color: #ffffff;
            font-weight: bold;
        }

        .carousel-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
        }

        .carousel-viewport { width: 100%; overflow: hidden; }
        .carousel-track { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .carousel-item { flex: 0 0 100%; padding: 2rem; min-height: 400px; display: flex; flex-direction: column; }

        .carousel-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .carousel-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .carousel-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .carousel-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dot.active { background: #ffffff; width: 32px; border-radius: 6px; }

        .file-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .file-item-info { display: flex; gap: 1rem; align-items: flex-start; }
        .file-icon { font-size: 3rem; }
        .file-details h3 { font-size: 1.2rem; color: #ffffff; margin-bottom: 0.3rem; word-break: break-word; }
        .file-details p { font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); }

        .file-item-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .file-action-btn { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .file-action-btn:hover { background: rgba(255, 255, 255, 0.15); }

        .file-preview-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-area video, .file-preview-area img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }

        .footer {
            margin-top: 4rem;
            padding: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .hero-title { font-size: 2.2rem; }
            .hero-subtitle { font-size: 1rem; }
            .upload-section { padding: 2rem 1.5rem; }
            .upload-area { padding: 2rem 1rem; min-height: 250px; }
            .upload-icon { font-size: 2.5rem; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo-container">
                <div class="logo-box">
                    <img src="/images/folder.png" alt="Avfile Logo">
                </div>
                <div>
                    <div class="logo-text">Avfile</div>
                    <div class="logo-tagline">File Sharing Made Simple</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" id="mainContainer">
        <!-- Upload UI (Home) -->
        <div id="uploadUI">
            <div class="hero">
                <h1 class="hero-title">Fast & Simple File Sharing</h1>
                <p class="hero-subtitle">
                    Share files instantly with anyone, anywhere. Upload up to 10 files at once and get a single shareable link. 
                    No registration needed, no size limits on uploads, and no expiration dates. Perfect for personal use, 
                    business sharing, or team collaboration.
                </p>
            </div>

            <section class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">‚Üë</div>
                    <h2>Drag & Drop Files Here</h2>
                    <p>Or click to select files from your computer</p>
                    <input type="file" id="fileInput" multiple />
                    <button class="btn" id="selectFileBtn">Select Files to Upload</button>
                    <p class="upload-hint">You can upload up to 10 files at once ‚Ä¢ All file types supported</p>
                </div>
            </section>

            <!-- Features Section -->
            <div class="features-section">
                <h2 class="features-title">Why Choose Avfile?</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">‚ö°</div>
                        <div class="feature-title">Lightning Fast</div>
                        <div class="feature-description">
                            Upload and share files instantly. Get your shareable link within seconds, even for large files.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üîí</div>
                        <div class="feature-title">Secure & Reliable</div>
                        <div class="feature-description">
                            Your files are stored securely and reliably. Share with confidence knowing your content is safe.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üåê</div>
                        <div class="feature-title">No Login Required</div>
                        <div class="feature-description">
                            Start sharing files immediately. No account, no password, no hassle. Just upload and share.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">‚ôæÔ∏è</div>
                        <div class="feature-title">No Expiration</div>
                        <div class="feature-description">
                            Your files never expire. Share links anytime, anywhere, and recipients can access them forever.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üé¨</div>
                        <div class="feature-title">Preview Support</div>
                        <div class="feature-description">
                            Preview videos, images, and PDFs directly. No need to download to see what you're sharing.
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üì¶</div>
                        <div class="feature-title">Multiple Files</div>
                        <div class="feature-description">
                            Share up to 10 files with a single link. Browse through all files using the carousel viewer.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Status Screen -->
        <div class="upload-status-screen" id="uploadStatusScreen">
            <div class="spinner"></div>
            <div class="status-title">Uploading Files...</div>
            <div id="statusMessage">0 / 0 files</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressPercent">0%</div>
        </div>

        <!-- Success Screen -->
        <div class="success-screen" id="successScreen">
            <div class="success-icon">‚úì</div>
            <div class="status-title">Upload Complete!</div>
            <div style="color: rgba(255, 255, 255, 0.8); margin-bottom: 2rem;">Your files are ready to share</div>
            <div class="share-url-box">
                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.8rem;">Share this link:</div>
                <div class="share-url-input-group">
                    <input type="text" id="shareUrl" readonly class="share-url-input" />
                    <button class="copy-btn" id="copyUrlBtn">Copy Link</button>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <button class="action-button" id="uploadMoreBtn">Upload More Files</button>
                <button class="action-button" id="openLinkBtn">Open Shared Link</button>
            </div>
        </div>

        <!-- Error Screen -->
        <div class="error-screen" id="errorScreen">
            <div class="error-icon">‚úó</div>
            <div class="status-title">Upload Failed</div>
            <div id="errorMsg" style="color: rgba(255, 255, 255, 0.8);">An error occurred</div>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <button class="action-button" style="background: rgba(255, 107, 107, 0.2); border-color: rgba(255, 107, 107, 0.4);" id="retryBtn">Try Again</button>
                <button class="action-button" id="backBtn">Back to Home</button>
            </div>
        </div>

        <!-- File Viewer -->
        <div class="file-viewer-container" id="fileViewerContainer">
            <div class="carousel-container">
                <div class="carousel-header">
                    <div class="carousel-title">Your Shared Files</div>
                </div>

                <div class="carousel-wrapper">
                    <div class="carousel-viewport">
                        <div class="carousel-track" id="carouselTrack"></div>
                    </div>
                </div>

                <div class="carousel-controls">
                    <button class="carousel-btn" id="prevBtn">Previous</button>
                    <span id="slideInfo" style="color: #ffffff;">1 / 1</span>
                    <button class="carousel-btn" id="nextBtn">Next</button>
                </div>

                <div class="carousel-dots" id="carouselDots"></div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingUI">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; color: rgba(255, 255, 255, 0.7);">Loading your files...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Avfile ‚Ä¢ Fast & Simple File Sharing</p>
    </footer>

<script>
// Cache ÁÆ°ÁêÜ
class Cache {
  static async downloadDirect(url, fileId) {
    try {
      console.log('[CACHE] Downloading:', fileId);
      const response = await fetch(url);
      if (!response.ok) throw new Error(`${response.status}`);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const dataUrl = e.target.result;
          try {
            localStorage.setItem(fileId, dataUrl);
          } catch (e) {
            window._cache = window._cache || {};
            window._cache[fileId] = dataUrl;
          }
          resolve(dataUrl);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.error('[CACHE] Error:', e.message);
      throw e;
    }
  }

  static getFromCache(fileId) {
    let dataUrl = localStorage.getItem(fileId);
    if (dataUrl) return dataUrl;
    if (window._cache && window._cache[fileId]) return window._cache[fileId];
    return null;
  }

  static clearAll() {
    localStorage.clear();
    window._cache = {};
  }
}

// GitHub Uploader
class GitHubUploader {
  constructor() {
    this.functionUrl = '/.netlify/functions/github-upload';
  }

  async createRelease(releaseTag, fileName) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create-release',
        releaseTag: releaseTag,
        metadata: { title: fileName, description: `File: ${fileName}` },
      }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error);
    return data.data;
  }

  async uploadAsset(uploadUrl, fileName, base64Data, fileId, fileSize) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'upload-asset',
        uploadUrl: uploadUrl,
        fileName: fileName,
        fileBase64: base64Data,
        fileId,
        fileSize,
      }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error);
    return data.data;
  }

  async getGithubJson() {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get-github-json' }),
    });
    if (!response.ok) return { files: [], views: [] };
    const data = await response.json();
    return data.success ? data.data : { files: [], views: [] };
  }

  async saveGithubJson(jsonData) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'save-github-json', jsonData: jsonData }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error);
    return data.data;
  }

  async createView(fileIds) {
    const response = await fetch(this.functionUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'create-view',
        fileIds,
        passwordHash: null,
        origin: window.location.origin
      })
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error);
    return data.data;
  }
}

// Carousel
class Carousel {
  constructor(track, dots, prevBtn, nextBtn, info) {
    this.track = track;
    this.dots = dots;
    this.prevBtn = prevBtn;
    this.nextBtn = nextBtn;
    this.info = info;
    this.current = 0;
    this.count = 0;

    prevBtn.addEventListener('click', () => this.prev());
    nextBtn.addEventListener('click', () => this.next());
  }

  addItem(el) {
    this.track.appendChild(el);
    this.count++;
    const dot = document.createElement('button');
    dot.className = `dot ${this.count === 1 ? 'active' : ''}`;
    dot.onclick = () => this.goTo(this.count - 1);
    this.dots.appendChild(dot);
    this.update();
  }

  next() {
    if (this.current < this.count - 1) {
      this.current++;
      this.update();
    }
  }

  prev() {
    if (this.current > 0) {
      this.current--;
      this.update();
    }
  }

  goTo(i) {
    if (i >= 0 && i < this.count) {
      this.current = i;
      this.update();
    }
  }

  update() {
    this.track.style.transform = `translateX(${-this.current * 100}%)`;
    document.querySelectorAll('.dot').forEach((d, i) => {
      d.classList.toggle('active', i === this.current);
    });
    this.info.textContent = `${this.current + 1} / ${this.count}`;
    this.prevBtn.disabled = this.current === 0;
    this.nextBtn.disabled = this.current === this.count - 1;
  }
}

// App
const MAX_FILES = 10;
const pathMatch = location.pathname.match(/^\/d\/([a-zA-Z0-9]+)/);
const viewId = pathMatch?.[1] || null;

function escapeHtml(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

function getIcon(name) {
  if (/\.(mp4|webm|ogg|mkv|avi|mov)$/i.test(name)) return 'V';
  if (/\.(jpg|jpeg|png|gif|webp)$/i.test(name)) return 'I';
  if (/\.(pdf)$/i.test(name)) return 'P';
  return 'F';
}

function formatSize(bytes) {
  const sizes = ['B', 'KB', 'MB', 'GB'];
  if (bytes === 0) return '0 B';
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function hideAll() {
  document.getElementById('uploadUI').style.display = 'none';
  document.getElementById('uploadStatusScreen').classList.remove('show');
  document.getElementById('successScreen').classList.remove('show');
  document.getElementById('errorScreen').classList.remove('show');
  document.getElementById('fileViewerContainer').classList.remove('show');
  document.getElementById('loadingUI').classList.remove('show');
}

function showUpload() { hideAll(); document.getElementById('uploadUI').style.display = 'block'; }
function showStatus() { hideAll(); document.getElementById('uploadStatusScreen').classList.add('show'); }
function showSuccess() { hideAll(); document.getElementById('successScreen').classList.add('show'); }
function showError(msg) { hideAll(); document.getElementById('errorMsg').textContent = msg; document.getElementById('errorScreen').classList.add('show'); }
function showLoading() { hideAll(); document.getElementById('loadingUI').classList.add('show'); }

document.getElementById('selectFileBtn').onclick = () => document.getElementById('fileInput').click();

const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop', async (e) => {
  e.preventDefault();
  uploadArea.classList.remove('drag-over');
  const files = Array.from(e.dataTransfer.files);
  if (files.length > MAX_FILES) { alert(`Max ${MAX_FILES} files`); return; }
  await uploadMultiple(files);
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  if (files.length > MAX_FILES) { alert(`Max ${MAX_FILES} files`); return; }
  await uploadMultiple(files);
});

document.getElementById('copyUrlBtn').onclick = async () => {
  const url = document.getElementById('shareUrl').value;
  await navigator.clipboard.writeText(url);
  document.getElementById('copyUrlBtn').textContent = 'Copied!';
  setTimeout(() => { document.getElementById('copyUrlBtn').textContent = 'Copy Link'; }, 2000);
};

document.getElementById('uploadMoreBtn').onclick = () => { showUpload(); document.getElementById('fileInput').value = ''; };
document.getElementById('openLinkBtn').onclick = () => window.open(document.getElementById('shareUrl').value);
document.getElementById('retryBtn').onclick = () => { showUpload(); document.getElementById('fileInput').value = ''; };
document.getElementById('backBtn').onclick = () => showUpload();

async function uploadMultiple(files) {
  showStatus();
  const uploader = new GitHubUploader();
  const ids = [];

  try {
    const promises = files.map((file, i) => (async () => {
      document.getElementById('statusMessage').textContent = `${i + 1} / ${files.length}`;
      
      const fileId = 'f_' + Math.random().toString(36).substr(2, 9);
      const base64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });

      const releaseData = await uploader.createRelease(`file_${fileId}`, file.name);
      await uploader.uploadAsset(releaseData.upload_url, file.name, base64, fileId, file.size);

      const githubJson = await uploader.getGithubJson();
      githubJson.files = githubJson.files || [];
      githubJson.files.push({
        fileId, fileName: file.name,
        downloadUrl: releaseData.assets_url || releaseData.upload_url,
        fileSize: file.size, uploadedAt: new Date().toISOString(),
      });

      await uploader.saveGithubJson(githubJson);

      const progress = Math.round(((ids.length + 1) / files.length) * 100);
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressPercent').textContent = progress + '%';

      return fileId;
    })());

    const results = await Promise.all(promises);
    ids.push(...results);

    const view = await uploader.createView(ids);
    document.getElementById('shareUrl').value = view.shareUrl;
    showSuccess();
  } catch (e) {
    showError(e.message);
  }
}

async function loadView(viewId) {
  try {
    const res = await fetch(`/.netlify/functions/view?id=${viewId}`);
    if (!res.ok) throw new Error('404');
    const data = await res.json();

    const carousel = new Carousel(
      document.getElementById('carouselTrack'),
      document.getElementById('carouselDots'),
      document.getElementById('prevBtn'),
      document.getElementById('nextBtn'),
      document.getElementById('slideInfo')
    );

    for (const file of data.files || []) {
      const item = document.createElement('div');
      item.className = 'carousel-item';

      const videoRegex = /\.(mp4|webm|ogg)$/i;
      const imageRegex = /\.(jpg|jpeg|png|gif|webp)$/i;
      const pdfRegex = /\.(pdf)$/i;

      let preview = '';
      if (videoRegex.test(file.fileName)) {
        preview = `<div class="file-preview-area" id="p-${file.fileId}"><div style="display: flex; align-items: center;"><div class="spinner" style="margin: 0 auto;"></div><div>Loading...</div></div></div>`;
      } else if (imageRegex.test(file.fileName)) {
        preview = `<div class="file-preview-area" id="p-${file.fileId}"><div style="display: flex; align-items: center;"><div class="spinner" style="margin: 0 auto;"></div><div>Loading...</div></div></div>`;
      } else if (pdfRegex.test(file.fileName)) {
        preview = `<div class="file-preview-area"><iframe src="${file.downloadUrl}" style="width: 100%; height: 100%; border: none;"></iframe></div>`;
      } else {
        preview = `<div class="file-preview-area"><p style="color: rgba(255, 255, 255, 0.7);"><a href="${file.downloadUrl}" download style="color: #ffffff;">Download file</a></p></div>`;
      }

      item.innerHTML = `
        <div style="flex: 1; display: flex; flex-direction: column;">
          <div class="file-item-header">
            <div class="file-item-info">
              <div class="file-icon">${getIcon(file.fileName)}</div>
              <div class="file-details">
                <h3>${escapeHtml(file.fileName)}</h3>
                <p>${formatSize(file.fileSize || 0)}</p>
              </div>
            </div>
            <div class="file-item-actions">
              <a href="${file.downloadUrl}" download class="file-action-btn">Download</a>
              <button class="file-action-btn" onclick="navigator.clipboard.writeText('${file.downloadUrl}'); this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy Link', 2000);">Copy Link</button>
            </div>
          </div>
          ${preview}
        </div>
      `;

      carousel.addItem(item);

      if (videoRegex.test(file.fileName) || imageRegex.test(file.fileName)) {
        (async () => {
          try {
            let dataUrl = Cache.getFromCache(file.fileId);
            if (!dataUrl) {
              dataUrl = await Cache.downloadDirect(file.downloadUrl, file.fileId);
            }

            const container = document.getElementById(`p-${file.fileId}`);
            if (!container) return;

            if (videoRegex.test(file.fileName)) {
              container.innerHTML = '<video controls style="max-width: 100%; max-height: 400px;"></video>';
              container.querySelector('video').src = dataUrl;
            } else {
              container.innerHTML = '<img style="max-width: 100%; max-height: 400px;" />';
              container.querySelector('img').src = dataUrl;
            }
          } catch (e) {
            const c = document.getElementById(`p-${file.fileId}`);
            if (c) c.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">Failed to load preview</p>';
          }
        })();
      }
    }

    hideAll();
    document.getElementById('fileViewerContainer').classList.add('show');
  } catch (e) {
    showError('File not found');
  }
}

window.addEventListener('beforeunload', () => Cache.clearAll());

if (viewId) {
  showLoading();
  loadView(viewId);
} else {
  showUpload();
}
</script>
</body>
</html>