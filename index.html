<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avfile - File Viewer</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        .viewer-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a2e;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            background: #0f0f1e;
            padding: 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewer-header a {
            color: #FFD700;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .viewer-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .viewer-content video,
        .viewer-content img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .viewer-controls {
            background: #0f0f1e;
            padding: 1rem;
            border-top: 1px solid #333;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-viewer {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-viewer:hover {
            background: #764ba2;
        }

        .error-box {
            background: #ff6b6b;
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem;
            text-align: center;
        }

        .loading {
            text-align: center;
            color: #fff;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="viewer-wrapper" id="viewerWrapper">
        <div class="viewer-header">
            <a href="/" style="color: #FFD700; text-decoration: none; font-weight: bold; font-size: 1.2rem;">‚Üê Avfile</a>
            <h2 id="fileName" style="color: white; margin: 0; flex: 1; text-align: center;">File Viewer</h2>
            <div style="width: 150px;"></div>
        </div>

        <div class="viewer-content" id="viewerContent">
            <!-- Upload Area when no ID -->
            <div id="uploadUI" style="display: none; width: 100%; max-width: 800px; margin: auto;">
                <div style="text-align: center; color: white; padding: 2rem;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;"> Avfile</h1>
                    <p style="font-size: 1.2rem; margin-bottom: 2rem;">Upload & Share Files Instantly</p>
                    
                    <div id="uploadArea" style="
                        border: 3px dashed #667eea;
                        border-radius: 8px;
                        padding: 3rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    "
                    onmouseover="this.style.borderColor='#764ba2'; this.style.background='rgba(102, 126, 234, 0.1)'"
                    onmouseout="this.style.borderColor='#667eea'; this.style.background='transparent'"
                    >
                        <svg style="width: 60px; height: 60px; margin: 0 auto 1rem; color: #FFD700;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 16 12 12 8 16"></polyline>
                            <line x1="12" y1="12" x2="12" y2="21"></line>
                            <path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path>
                        </svg>
                        <h2>Drop Files or Click to Upload</h2>
                        <p style="color: #ccc;">Max 100MB ‚Ä¢ All file types supported</p>
                        <input type="file" id="fileInput" accept="*/*" style="display: none" />
                        <button id="selectFileBtn" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-top: 1rem;">Select File</button>
                    </div>
                </div>
            </div>

            <!-- Loading when checking file -->
            <div id="loadingUI" style="display: none; text-align: center; color: white;">
                <div style="border: 4px solid #333; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto;"></div>
                <p>Loading file...</p>
            </div>

            <!-- Viewer when file found -->
            <div id="fileViewerUI" style="display: none;"></div>

            <!-- Error when file not found -->
            <div id="errorUI" style="display: none; text-align: center; color: white;">
                <h2>‚ùå File Not Found</h2>
                <p id="errorMessage" style="color: #ccc;">The file you're looking for doesn't exist.</p>
                <a href="/" style="color: #FFD700; text-decoration: underline; display: inline-block; margin-top: 1rem;">Back to Home</a>
            </div>
        </div>

        <div class="viewer-controls" id="viewerControls" style="background: #0f0f1e; padding: 1rem; border-top: 1px solid #333; display: none; gap: 1rem; justify-content: center;">
            <button class="btn-viewer" id="downloadBtn">üì• Download</button>
            <button class="btn-viewer" id="shareBtn">üîó Copy Link</button>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .viewer-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a2e;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            background: #0f0f1e;
            padding: 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewer-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .viewer-content video,
        .viewer-content img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .viewer-controls {
            background: #0f0f1e;
            padding: 1rem;
            border-top: 1px solid #333;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-viewer {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-viewer:hover {
            background: #764ba2;
        }
    </style>

    <script src="js/storage.js"></script>
    <script src="js/github-api-netlify.js"></script>
    <script>
        // Initialize app
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');

        console.log('Avfile loaded');
        console.log('File ID:', fileId);

        let currentFile = null;

        async function initApp() {
            try {
                if (!fileId) {
                    // Mode: Upload/Home
                    console.log('Mode: Home/Upload');
                    showUploadUI();
                    setupUploadHandlers();
                } else {
                    // Mode: Viewer
                    console.log('Mode: Viewer');
                    showLoadingUI();
                    await loadAndDisplayFile();
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorUI(error.message);
            }
        }

        function showUploadUI() {
            document.getElementById('uploadUI').style.display = 'block';
            document.getElementById('loadingUI').style.display = 'none';
            document.getElementById('fileViewerUI').style.display = 'none';
            document.getElementById('errorUI').style.display = 'none';
            document.getElementById('viewerControls').style.display = 'none';
        }

        function showLoadingUI() {
            document.getElementById('uploadUI').style.display = 'none';
            document.getElementById('loadingUI').style.display = 'block';
            document.getElementById('fileViewerUI').style.display = 'none';
            document.getElementById('errorUI').style.display = 'none';
            document.getElementById('viewerControls').style.display = 'none';
        }

        function showFileViewerUI() {
            document.getElementById('uploadUI').style.display = 'none';
            document.getElementById('loadingUI').style.display = 'none';
            document.getElementById('fileViewerUI').style.display = 'block';
            document.getElementById('errorUI').style.display = 'none';
            document.getElementById('viewerControls').style.display = 'flex';
        }

        function showErrorUI(message) {
            document.getElementById('uploadUI').style.display = 'none';
            document.getElementById('loadingUI').style.display = 'none';
            document.getElementById('fileViewerUI').style.display = 'none';
            document.getElementById('errorUI').style.display = 'block';
            document.getElementById('viewerControls').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        async function loadAndDisplayFile() {
            try {
                // Get file from localStorage
                const uploadManager = new SimpleUploadManager();
                const fileData = uploadManager.getFileData(fileId);

                console.log('File data:', fileData);

                if (!fileData) {
                    showErrorUI(`File not found: ${fileId}`);
                    return;
                }

                currentFile = fileData;

                // Display file info
                document.getElementById('fileName').textContent = fileData.name || 'File';

                // Display file content
                const isVideo = fileData.type?.startsWith('video/');
                const isImage = fileData.type?.startsWith('image/');
                const fileViewerUI = document.getElementById('fileViewerUI');

                if (isVideo && fileData.data) {
                    const base64 = fileData.data;
                    fileViewerUI.innerHTML = `<video controls style="max-width: 90%; max-height: 90%;">
                        <source src="data:${fileData.type};base64,${base64}" type="${fileData.type}" />
                        Your browser does not support the video tag.
                    </video>`;
                } else if (isImage && fileData.data) {
                    const base64 = fileData.data;
                    fileViewerUI.innerHTML = `<img src="data:${fileData.type};base64,${base64}" alt="${escapeHtml(fileData.name)}" style="max-width: 90%; max-height: 90%;" />`;
                } else if (fileData.data) {
                    const sizeMB = ((fileData.size || 0) / 1024 / 1024).toFixed(1);
                    fileViewerUI.innerHTML = `<div style="color: white; text-align: center;">
                        <h3>${escapeHtml(fileData.name || 'File')}</h3>
                        <p>Size: ${sizeMB} MB</p>
                        <p>Type: ${fileData.type || 'Unknown'}</p>
                        <button id="downloadBtnLarge" style="background: #667eea; color: white; border: none; padding: 1rem 2rem; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-top: 2rem;">üì• Download File</button>
                    </div>`;
                    document.getElementById('downloadBtnLarge')?.addEventListener('click', () => downloadFile(fileData));
                } else {
                    showErrorUI('File data is corrupted or missing');
                    return;
                }

                // Setup buttons
                setupViewerButtons(fileData);

                // Show viewer
                showFileViewerUI();

            } catch (error) {
                console.error('Error loading file:', error);
                showErrorUI(error.message);
            }
        }

        function setupUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const selectFileBtn = document.getElementById('selectFileBtn');
            const fileInput = document.getElementById('fileInput');

            // File input
            selectFileBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#764ba2';
                uploadArea.style.background = 'rgba(102, 126, 234, 0.1)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.background = 'transparent';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.background = 'transparent';
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
        }

        async function handleFileUpload(file) {
            try {
                console.log('Uploading file:', file.name);

                // Upload to localStorage
                const uploadManager = new SimpleUploadManager();
                const result = await uploadManager.createDemoUpload(
                    file,
                    file.name,
                    (progress, message) => {
                        console.log(`${progress}% - ${message}`);
                    }
                );

                console.log('Upload result:', result);

                // Generate share link
                const shareUrl = `${window.location.origin}/?id=${result.fileId}`;
                
                // Show success
                alert(`‚úÖ File uploaded!\n\nShare link:\n${shareUrl}`);

                // Copy to clipboard
                navigator.clipboard.writeText(shareUrl);

                // Redirect to new file
                window.location.href = shareUrl;

            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            }
        }

        function setupViewerButtons(fileData) {
            document.getElementById('downloadBtn').addEventListener('click', () => {
                downloadFile(fileData);
            });

            document.getElementById('shareBtn').addEventListener('click', () => {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied to clipboard!');
                });
            });
        }

        function downloadFile(fileData) {
            try {
                const fileName = fileData.name || 'file';
                const link = document.createElement('a');
                link.href = `data:${fileData.type || 'application/octet-stream'};base64,${fileData.data}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('Download started:', fileName);
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed. Please try again.');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        initApp();
    </script>
</body>
</html>