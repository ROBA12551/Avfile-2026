<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avfile - File Viewer</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        .viewer-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a2e;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            background: #0f0f1e;
            padding: 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewer-header a {
            color: #FFD700;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .viewer-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .viewer-content video,
        .viewer-content img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .viewer-controls {
            background: #0f0f1e;
            padding: 1rem;
            border-top: 1px solid #333;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-viewer {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-viewer:hover {
            background: #764ba2;
        }

        .error-box {
            background: #ff6b6b;
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem;
            text-align: center;
        }

        .loading {
            text-align: center;
            color: #fff;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="viewer-wrapper" id="viewerWrapper">
        <div class="viewer-header">
            <a href="/">‚Üê Back to Home</a>
            <h2 id="fileName" style="color: white; margin: 0; flex: 1; text-align: center;">Loading...</h2>
            <div style="width: 150px;"></div>
        </div>

        <div class="viewer-content" id="viewerContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading file...</p>
            </div>
        </div>

        <div class="viewer-controls">
            <button class="btn-viewer" id="downloadBtn">üì• Download</button>
            <button class="btn-viewer" id="shareBtn">üîó Copy Link</button>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/simple-upload.js"></script>
    <script>
        // URL „Åã„Çâ„Éï„Ç°„Ç§„É´ ID „ÇíÂèñÂæó
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');

        console.log('View page loaded');
        console.log('File ID:', fileId);
        console.log('URL:', window.location.href);

        let currentFile = null;

        async function initViewer() {
            try {
                if (!fileId) {
                    showError('No file ID provided. Use ?id=your-file-id');
                    return;
                }

                // „Éï„Ç°„Ç§„É´„ÇíÂèñÂæó
                const uploadManager = new SimpleUploadManager();
                const fileData = uploadManager.getFileData(fileId);

                console.log('File data:', fileData);

                if (!fileData) {
                    showError(`File not found: ${fileId}`);
                    return;
                }

                currentFile = fileData;

                // „Éï„Ç°„Ç§„É´Âêç„ÇíË°®Á§∫
                document.getElementById('fileName').textContent = fileData.name || 'File';

                // „Éï„Ç°„Ç§„É´„ÇíË°®Á§∫
                displayFile(fileData);

                // „Éú„Çø„É≥„ÇíË®≠ÂÆö
                setupButtons(fileData);

            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            }
        }

        function displayFile(fileData) {
            const isVideo = fileData.type?.startsWith('video/');
            const isImage = fileData.type?.startsWith('image/');
            const viewerContent = document.getElementById('viewerContent');

            if (isVideo && fileData.data) {
                // „Éì„Éá„Ç™ÂÜçÁîü
                const base64 = fileData.data;
                viewerContent.innerHTML = `<video controls style="max-width: 90%; max-height: 90%;">
                    <source src="data:${fileData.type};base64,${base64}" type="${fileData.type}" />
                    Your browser does not support the video tag.
                </video>`;
            } else if (isImage && fileData.data) {
                // ÁîªÂÉèË°®Á§∫
                const base64 = fileData.data;
                viewerContent.innerHTML = `<img src="data:${fileData.type};base64,${base64}" alt="${escapeHtml(fileData.name)}" />`;
            } else if (fileData.data) {
                // „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç°„Ç§„É´
                const sizeMB = ((fileData.size || 0) / 1024 / 1024).toFixed(1);
                viewerContent.innerHTML = `<div style="color: white; text-align: center;">
                    <h3>${escapeHtml(fileData.name || 'File')}</h3>
                    <p>Size: ${sizeMB} MB</p>
                    <p>Type: ${fileData.type || 'Unknown'}</p>
                    <button class="btn-viewer" style="margin-top: 2rem;" id="downloadBtnLarge">üì• Download File</button>
                </div>`;
                document.getElementById('downloadBtnLarge')?.addEventListener('click', () => downloadFile(fileData));
            } else {
                showError('File data is corrupted or missing');
            }
        }

        function setupButtons(fileData) {
            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
            document.getElementById('downloadBtn').addEventListener('click', () => {
                downloadFile(fileData);
            });

            // ÂÖ±Êúâ„Éú„Çø„É≥
            document.getElementById('shareBtn').addEventListener('click', () => {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied to clipboard!');
                });
            });
        }

        function downloadFile(fileData) {
            try {
                const fileName = fileData.name || 'file';
                const link = document.createElement('a');
                link.href = `data:${fileData.type || 'application/octet-stream'};base64,${fileData.data}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('Download started:', fileName);
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed. Please try again.');
            }
        }

        function showError(message) {
            const viewerContent = document.getElementById('viewerContent');
            viewerContent.innerHTML = `<div class="error-box">
                <h2>‚ùå Error</h2>
                <p>${escapeHtml(message)}</p>
                <a href="/" style="color: white; text-decoration: underline; display: inline-block; margin-top: 1rem;">Go Home</a>
            </div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÂàùÊúüÂåñ
        initViewer();
    </script>
</body>
</html>